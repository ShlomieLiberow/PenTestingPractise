# coding=utf-8

import os

import requests
from bs4 import BeautifulSoup


def connect():
    print('[*] Greetings xx')
    print('[*] Logging into site...')
    session = requests.Session()
    # Login with 'multipart/form-data' for some bizarre reason. Seems to require dicts containing tuples
    session.post('http://www.xx.com/homes/login?url=homes%2Flogin',
                 files={'_method': (None, 'POST'), 'data[Home][username]': (None, 'xx'),
                        'data[Home][password]': (None, 'london')})
    session.post('http://www.xx.com/homes/event_details/xx', data={'image_number': '100'})

    print('[*] Scanning for High Definition images...')
    img_list = []
    for x in range(14):
        logged_in_screen = session.get(
            'http://www.xx.com/homes/event_details/xx/page:{0}?url=homes%2Fevent_details%2Fxx'.format(x))

        html_response_parser = BeautifulSoup(logged_in_screen.content, 'html.parser')

        for tag in html_response_parser.select('[src*=upload/500X500]'):
            img_list.append(tag['src'])
    print('[*] Image links found: ' + str(len(img_list)))
    return img_list


def image_download(image):
    print('[*] Printing images to disc...')
    tracker = 0
    base = 'http://www.xx.com/'
    for f in image:
        single_image_download = requests.get(base + f)
        tracker += 1
        file_name = 'pics/' + str(tracker) + '.jpg'
        print(str(tracker) + '.jpg printed')
        os.makedirs(os.path.dirname(file_name), exist_ok=True)
        with open(file_name, 'wb') as output:
            for chunk in single_image_download.iter_content():
                output.write(chunk)
    print('[*] All done. Images have been downloaded to pics folder...')
    print('[*] Goodbye xx')


def main():
    img_list = connect()
    image_download(img_list)


if __name__ == '__main__':
    main()
